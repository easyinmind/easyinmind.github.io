---
title: 项目基于Jenkins发版流程
date: 2021-08-10 15:53:35
permalink: /pages/d17ca6/
categories:
  - 运维&其它
tags:
  - CI&CD
  - jenkins
---
## 机器
+ Jenkisns 机器 =》122
+ dev 机器 =》72
+ beta 机器 =》30
+ production 机器 =》 113/142
## 环境
+ dev: dev1/dev1/dev2/dev3
+ beta: beta/beta1/beat2
+ production: production

## 发布流程简述
+ 点击发布之后，jenkins会根据配置及选择拉取git仓库代码到指定目录下（参考jenkins配置）`/var/lib/jenkins/workspace/hxxk-build-(环境名dev/dev1/beta/beta1/production..)`
+ 然后会执行jenkins配置的对应脚本，进行依赖安装、打包编译，将打包完的静态资源scp到对应环境的机器上

## dev环境流程
1. 点击发布，拉取代码到jenkins机器指定目录
2. 执行配置脚本
   1. npm install && npm run build
   2. ssh dev环境的机器 rm上次的资源
   3. ssh dev环境的机器 scp静态资源到dev环境机器

## beta
> beta环境的发布会在jenkins机器上保留历史编译产物，beta1/beta2作为测试使用，beta环境作为线上环境上线的预编译发布环境
1. 拉取代码
2. 编译打包，将前缀(beta/beta1/beta2)+时间戳作为版本号保存当前静态资源
   + 如果是beta，则不会增加前缀只使用时间戳作为版本，方便线上环境上线的时候使用
3. 根据版本号在beta机器上创建文件夹，将静态资源scp到新创建的目录内
4. 删除beta环境之前的软链，创建新的软链指向新创建的目录
5. 遍历beta环境之前的历史版本，删除最早的一个，持续保证N个历史版本，方便回退

## production
> 线上环境上线之前必须先发beta环境，线上环境发版不进行编译打包，直接scp jenkins环境beta
1. 获取jenkins机器上最新beta预编译静态资源，并获取版本号（时间戳的文件名）
2. 根据版本号在线上机器创建新的目录，将beta最新的静态资源scp到新的目录
3. 删除之前的软链，新建软链指向最新创建的目录
4. 遍历历史资源，删除最早的一个，持续保留N个历史记录，方便回退

## roll-back
> 版本回退，一般只需要回退beta和线上环境即可
1. 在要回退的环境机器上获取所有持续保留的静态资源文件版本号
2. 根据配置的参数，遍历版本号判断出要回退的版本
3. 删除软链，新建软链指向这个版本

## jenkin机器目录
针对每个环境，jenkins都会有一个运行目录，如：dev1-build、dev2-build、beta-build等。从git上拉取的代码，及install依赖、build都会在这个目录内进行。可以理解为本地开发环境。  
可以将beta（预编译、预发布）环境历史构建静态资源统一保留在一个目录，如：build-package，这样真正发布线上环境的时候只需要scp最新编译好的静态资源即可，不需要再花费时间编译。
## dev环境机器目录
+ /xxx/xxx/dev1 最新版本
+ /xxx/xxx/dev2 最新版本
+ /xxx/xxx/dev3 最新版本
## beta环境机器目录
+ /xxx/xxx/beta软链 =》指向beta最新版本
+ /xxx/xxx/beta 版本1
+ /xxx/xxx/beta 版本2
+ /xxx/xxx/beta 版本3
+ /xxx/xxx/beta1软链 =》指向beta1最新版本
+ /xxx/xxx/beta1 版本1
+ /xxx/xxx/beta2 版本2
+ /xxx/xxx/beta3 版本3
+ ...

## 线上环境机器目录
+ /xxx/xxx/线上软链 =》指向线上最新版本
+ /xxx/xxx/线上 版本1
+ /xxx/xxx/线上 版本2
+ /xxx/xxx/线上 版本3

## 目录内
一般包括前端编译完的静态文件，html/css/js/img。 可以将nginx配置放在这里，方便前端配置。可以通过外部的软链，链接到这里的nginx配置。