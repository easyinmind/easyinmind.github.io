(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{428:function(t,s,a){"use strict";a.r(s);var n=a(21),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"浏览器渲染"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#浏览器渲染"}},[t._v("#")]),t._v(" 浏览器渲染")]),t._v(" "),a("blockquote",[a("p",[t._v("渲染工作主要是在 "),a("em",[t._v("渲染进程")]),t._v(" 和 "),a("em",[t._v("GPU进程")]),t._v(" 中进行的\n渲染进程：主线程（html解析器，css解析器，v8）、合成线程、图块栅格化线程\nGPU 进程：GPU 线程")])]),t._v(" "),a("h2",{attrs:{id:"简述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简述"}},[t._v("#")]),t._v(" 简述")]),t._v(" "),a("p",[t._v("浏览器并不认识html和css，所以会将html转为dom树，css转为styleSheets，然后结合成布局树，再进行其它的一些操作。整个过程是一个串行的过程，大部分工作都在主线程内处理。中间分为很多阶段，每个阶段都会有一个输入内容和输出内容。\n构建 DOM 树、样式计算、布局阶段、分层、绘制、分块、光栅化和合成。")]),t._v(" "),a("h2",{attrs:{id:"概念"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#概念"}},[t._v("#")]),t._v(" 概念")]),t._v(" "),a("h2",{attrs:{id:"流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流程"}},[t._v("#")]),t._v(" 流程")]),t._v(" "),a("blockquote",[a("p",[t._v("主线程中执行")])]),t._v(" "),a("h2",{attrs:{id:"构建-dom-树"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#构建-dom-树"}},[t._v("#")]),t._v(" 构建 DOM 树")]),t._v(" "),a("blockquote",[a("p",[t._v("html => domTree\n将html转为浏览器可以识别的dom树")])]),t._v(" "),a("h2",{attrs:{id:"样式计算"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#样式计算"}},[t._v("#")]),t._v(" 样式计算")]),t._v(" "),a("blockquote",[a("p",[t._v("css => styleSheets")])]),t._v(" "),a("ol",[a("li",[t._v("将css转为浏览器可以识别的结构styleSheets\n"),a("ol",[a("li",[t._v("外链")]),t._v(" "),a("li",[t._v("内嵌")]),t._v(" "),a("li",[t._v("行内")])])]),t._v(" "),a("li",[t._v("属性值标准化（2em 被解析成了 32px，red 被解析成了 rgb(255,0,0)，bold 被解析成了 700）")]),t._v(" "),a("li",[t._v("根据继承和层叠规则计算出dom节点中每个元素的具体样式，默认有UserAgent样式")])]),t._v(" "),a("h2",{attrs:{id:"布局过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#布局过程"}},[t._v("#")]),t._v(" 布局过程")]),t._v(" "),a("blockquote",[a("p",[t._v("domTree/styleSheets => loayoutTree")])]),t._v(" "),a("ol",[a("li",[t._v("创建布局树（只包含可见元素，或者可绘制元素）")]),t._v(" "),a("li",[t._v("布局计算（计算出元素的位置）")])]),t._v(" "),a("h2",{attrs:{id:"分层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分层"}},[t._v("#")]),t._v(" 分层")]),t._v(" "),a("blockquote",[a("p",[t._v("loayoutTree => layerTree")])]),t._v(" "),a("ol",[a("li",[t._v("特定节点生成专用图层，生成一棵图层树（层叠上下文、Clip，类似 PhotoShop 里的图层）；")]),t._v(" "),a("li",[t._v("拥有层叠上下文属性（明确定位属性、透明属性、CSS 滤镜、z-index 等）的元素会创建单独图层；")]),t._v(" "),a("li",[t._v("没有图层的 DOM 节点属于父节点图层；")]),t._v(" "),a("li",[t._v("需要剪裁的地方也会创建图层。（overflow）")])]),t._v(" "),a("h2",{attrs:{id:"绘制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#绘制"}},[t._v("#")]),t._v(" 绘制")]),t._v(" "),a("blockquote",[a("p",[t._v("layerTree => 图层绘制指令列表"),a("br"),t._v("\n每个layer（图层）对应一个列表")])]),t._v(" "),a("ol",[a("li",[t._v("输入：图层树；")]),t._v(" "),a("li",[t._v("渲染引擎对图层树中每个图层进行绘制；")]),t._v(" "),a("li",[t._v("拆分成绘制指令，生成绘制列表，提交到合成线程；")]),t._v(" "),a("li",[t._v("输出：绘制列表。")])]),t._v(" "),a("blockquote",[a("p",[t._v("下面是在合成线程中执行")])]),t._v(" "),a("h2",{attrs:{id:"分块"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#分块"}},[t._v("#")]),t._v(" 分块")]),t._v(" "),a("blockquote",[a("p",[t._v("图层 => 图块\n合成线程会将图层（一屏显示不完，大部分不在视口内）划分为图块（tile, 256"),a("em",[t._v("256, 512")]),t._v("512）。")])]),t._v(" "),a("h2",{attrs:{id:"栅格化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#栅格化"}},[t._v("#")]),t._v(" 栅格化")]),t._v(" "),a("blockquote",[a("p",[t._v("图块 => 位图")])]),t._v(" "),a("ol",[a("li",[t._v("栅格化：将图块转化为位图（位图在cpu内存）")]),t._v(" "),a("li",[t._v("快速栅格化：使用GPU 生成位图的过程（位图在gpu内存）")]),t._v(" "),a("li",[t._v("渲染进程维护了一个栅格化的线程池，所有的图块栅格化都是在线程池内执行的")]),t._v(" "),a("li",[t._v("合成线程会优先为 "),a("em",[t._v("视口")]),t._v(" 附近的图块生成位图")])]),t._v(" "),a("h2",{attrs:{id:"合成显示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#合成显示"}},[t._v("#")]),t._v(" 合成显示")]),t._v(" "),a("blockquote",[a("p",[t._v("位图 => 页面\n所有图块被栅格化之后，合成线程就会生成一个绘制图块的命令——“DrawQuad”，然后将该命令提交给浏览器进程。浏览器进程里面有一个叫 viz 的组件，用来接收合成线程发过来的 DrawQuad 命令，然后根据 DrawQuad 命令，将其页面内容绘制到内存中，最后再将内存显示在屏幕上。")])]),t._v(" "),a("h2",{attrs:{id:"关于交互"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于交互"}},[t._v("#")]),t._v(" 关于交互")]),t._v(" "),a("ol",[a("li",[t._v("浏览器进程接收触发的事件，将事件目标和事件类型发送给渲染进程的合成线程")]),t._v(" "),a("li",[t._v("合成线程根据事件目标来运行注册的监听程序")])]),t._v(" "),a("h2",{attrs:{id:"重排重绘合成"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重排重绘合成"}},[t._v("#")]),t._v(" 重排重绘合成")]),t._v(" "),a("ol",[a("li",[t._v("构建DOM树 =》主线程")]),t._v(" "),a("li",[t._v("计算样式 =》主线程")]),t._v(" "),a("li",[t._v("Layout布局 =》主线程 =》 重排触发")]),t._v(" "),a("li",[t._v("Layer分层 =》主线程 =》 重排触发")]),t._v(" "),a("li",[t._v("paint绘制命令 =》主线程 =》 重排触发 =》 重绘触发")]),t._v(" "),a("li",[t._v("分块 =》合成线程 =》 重排触发 =》 重绘触发 =》 合成触发")]),t._v(" "),a("li",[t._v("栅格化 =》合成线程 =》 重排触发 =》 重绘触发 =》 合成触发")]),t._v(" "),a("li",[t._v("合成 =》合成线程 =》 重排触发 =》 重绘触发 =》 合成触发")])]),t._v(" "),a("h2",{attrs:{id:"优化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#优化"}},[t._v("#")]),t._v(" 优化")]),t._v(" "),a("p",[t._v("减少触发次数")]),t._v(" "),a("ol",[a("li",[t._v("使用class统一改变")]),t._v(" "),a("li",[t._v("批量dom操作使用createDocumentFragment")]),t._v(" "),a("li",[t._v("虚拟dom计算差异后统一处理")])]),t._v(" "),a("h2",{attrs:{id:"关于css、js阻塞问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于css、js阻塞问题"}},[t._v("#")]),t._v(" 关于css、js阻塞问题")]),t._v(" "),a("ol",[a("li",[t._v("HTML 解析器在解析到 script 标签时，会暂停 DOM 的解析，因为js可能要修改当前已经生成的 DOM 结构。这时候 HTML 解析器暂停工作，JavaScript 引擎介入执行代码，执行完成之后HTML 解析器回复解析过程。（如果js代码没有dom操作，可以使用defer、async属性）\n"),a("ol",[a("li",[t._v("async：下载完就执行（省去了下载时间），不确定执行顺序")]),t._v(" "),a("li",[t._v("defer：DOMContentLoaded事件之前执行（即所有资源下载完成），按顺序执行")])])]),t._v(" "),a("li",[t._v("js下载过程会阻塞 DOM解析，不过 Chrome 做了 "),a("em",[t._v("预解析操作")]),t._v("，渲染引擎接收到字节流后悔开启一个预解析线程分析HTML中的js、css，提前下载这些文件")]),t._v(" "),a("li",[t._v("如果代码里引用了外部的 CSS 文件，那么在执行 JavaScript 之前，还需要等待外部的 CSS 文件下载完成，并解析生成 CSSOM 对象之后，才能执行 JavaScript 脚本。")])]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("head")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("style")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("theme.css"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token style"}}),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("style")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("head")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("body")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("1"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token script"}},[a("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" div1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getElementsByTagName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'div'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n        div1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("innerText "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'time.geekbang'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//需要DOM")]),t._v("\n        div1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("style"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("color "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'red'")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//需要CSSOM")]),t._v("\n    ")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("test"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("body")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("html")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("p",[t._v("而 JavaScript 引擎在解析 JavaScript 之前，是不知道 JavaScript 是否操纵了 CSSOM 的，所以渲染引擎在遇到 JavaScript 脚本时，不管该脚本是否操纵了 CSSOM，都会执行 CSS 文件下载，解析操作，再执行 JavaScript 脚本")]),t._v(" "),a("p",[t._v("总结：")]),t._v(" "),a("ol",[a("li",[t._v("CSS不阻塞dom的生成。")]),t._v(" "),a("li",[t._v("CSS不阻塞js的加载，但是会阻塞js的执行。")]),t._v(" "),a("li",[t._v("js会阻塞dom的生成，也就是会阻塞页面的渲染，那么css也有可能会阻塞页面的渲染。")])])])}),[],!1,null,null,null);s.default=e.exports}}]);